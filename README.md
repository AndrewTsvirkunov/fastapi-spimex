# FastAPI Spimex

Веб-сервис для работы с результатами торгов СПбМТСБ (SPIMEX).  
Реализован на **FastAPI**, **SQLAlchemy (async)**, **Alembic** (для миграций) и **Redis** (для кэширования).

---

## Возможности
- Получение списка дат последних торговых дней.
- Получение списка торгов за заданный период.
- Получение списка последних торгов.
- Асинхронная работа с БД (PostgreSQL).
- Кэширование ответов в Redis до ближайшего 14:11 (по заданной таймзоне).

---

## Установка и запуск

### 1. Клонируйте репозиторий
```
git clone https://github.com/AndrewTsvirkunov/fastapi-spimex.git
```
### 2. Перейдите в папку
```
cd fastapi_spimex
```
### 3. Создайте и активируйте виртуальное окружение
```
python -m venv .venv
```
Для Linux / macOS
```
source .venv/bin/activate
```
Для Windows
```
.venv\Scripts\activate
```
### 4. Установите зависимости
```
pip install -r requirements.txt
```
### 5. .env
Создайте файл с переменными окружения, опираясь на .env.example.<br>
Настройте подключение к БД, Redis и таймзону.

### 6. Примените миграции
```
alembic upgrade head
```
### 7. Запустите сервер
```
uvicorn app.main:app --reload
```
Сервер будет доступен по адресу http://127.0.0.1:8000<br>
Документация OpenAPI:
http://127.0.0.1:8000/docs или
http://127.0.0.1:8000/redoc

---

## Тестирование

### 1. Настройте тестовую БД
Добавьте *TEST_DB_NAME* в ваш .env (см. .env.example)

### 2. Запустите все тесты
```
pytest
```

### 3. Для отчета о покрытии кода
```
pytest --cov=app --cov=cache --cov-report=html
```
### Отчет о покрытии кода будет доступен в htmlcov/index.html

---

## Обоснование выбора обязательных параметров

### 1. last_trading_dates
Обязательный параметр: days (сколько последних торговых дней)
Обоснование: без него неоднозначно, сколько дат возвращать. Значение по умолчанию - 1 (последний день).

### 2. dynamics
Обязательные параметры: start_date и end_date.
Обоснование: без дат определить границы периода невозможно.
Фильтры по oil_id, delivery_type_id, delivery_basis_id - опциональны.

### 3. trading_results
Обязательный параметр: days (по умолчанию 1) - сколько последних торговых дат включить.
Обоснование: термин в условии задачи "последние торги" без уточнения размера неоднозначен.
Фильтры по oil_id, delivery_type_id, delivery_basis_id - опциональны.

